### 3æœˆ19æ—¥ bugä¿®å¤è¿‡ç¨‹

**ğŸ¯ é—®é¢˜åˆ†æï¼šCharacterController ä¸ç©å®¶ä½ç½®æœªæ­£ç¡®é‡ç½®çš„é—®é¢˜**



åœ¨ Unity ä¸­ï¼ŒCharacterController ä¸ Rigidbody ç•¥æœ‰ä¸åŒï¼Œå…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹æ€§ï¼š



âœ… **ä¸å—ç‰©ç†å¼•æ“çš„è‡ªåŠ¨æ§åˆ¶**ï¼ˆä¸åƒ Rigidbody ä¾èµ– FixedUpdate()ï¼‰

âœ… åªèƒ½é€šè¿‡ CharacterController.Move() æˆ– CharacterController.SimpleMove() ç§»åŠ¨

âœ… ç›´æ¥ä¿®æ”¹ transform.position æ—¶ï¼ŒCharacterController å¯èƒ½å­˜åœ¨ **å»¶è¿Ÿæ›´æ–°** æˆ– **ç¢°æ’é—®é¢˜**



å› æ­¤ï¼Œ**CharacterController ä½ç½®æ›´æ–°é—®é¢˜** çš„æ ¹æœ¬åŸå› é€šå¸¸å‡ºåœ¨ä»¥ä¸‹å‡ æ–¹é¢ï¼š



------



**ğŸ” å¯èƒ½åŸå› ä¸è§£å†³æ–¹æ³•**



------



**ğŸŸ¡ 1. CharacterController çš„å†…éƒ¨ç¼“å­˜æœªè¢«åˆ·æ–°**



> CharacterController å†…éƒ¨ç»´æŠ¤ç€è‡ªå·±çš„â€œç¢°æ’ä½“çŠ¶æ€â€ä¸â€œå½“å‰ä½ç½®ç¼“å­˜â€ï¼Œå¦‚æœä½ åœ¨ transform.position ç›´æ¥é‡ç½®ä½ç½®ï¼Œè€Œæœªè°ƒç”¨ Move()ï¼Œå®ƒçš„å†…éƒ¨çŠ¶æ€å¯èƒ½ä»ç„¶é”™è¯¯ã€‚



â— **é—®é¢˜æè¿°ï¼š**

â€‹	â€¢	transform.position = startingPosition; å¯èƒ½æ²¡æœ‰ç«‹å³æ›´æ–° CharacterController çš„ç¢°æ’å™¨çŠ¶æ€ã€‚

â€‹	â€¢	è¿™åœ¨è§’è‰²æ­»äº¡æ—¶å¦‚æœè§¦å‘äº†ç‰©ç†ç¢°æ’ï¼Œå¯èƒ½ä¼šé€ æˆâ€œå¡åœ¨åœ°é¢â€æˆ–â€œä½ç½®é”™ä¹±â€ç­‰é—®é¢˜ã€‚



âœ… **è§£å†³æ–¹æ³• (æ¨è)**ï¼š

è°ƒç”¨ CharacterController.Move(Vector3.zero) ä»¥å¼ºåˆ¶åˆ·æ–°å…¶å†…éƒ¨ç¼“å­˜ï¼š

```
public void Respawn()
{
    transform.position = startingPosition;  
    CharacterController controller = GetComponent<CharacterController>();
    if (controller != null)
    {
        controller.enabled = false;     // ç¦ç”¨å¹¶å¯ç”¨ä»¥åˆ·æ–°çŠ¶æ€
        controller.enabled = true;      
        controller.Move(Vector3.zero);  // å¼ºåˆ¶åˆ·æ–°ä½ç½®å’Œç¢°æ’çŠ¶æ€
    }
}
```





------



**ğŸŸ¡ 2. CharacterController å¯èƒ½æ®‹ç•™æ—§çš„ç¢°æ’ä¿¡æ¯**



> å¦‚æœç©å®¶åœ¨æ­»äº¡æ—¶æ­£ä¸æŸä¸ªç¢°æ’ä½“æ¥è§¦ï¼ŒCharacterController å¯èƒ½ä¼šåœ¨é‡ç”Ÿåé”™è¯¯åœ°â€œå¡åœ¨â€è¯¥ä½ç½®ã€‚



â— **é—®é¢˜æè¿°ï¼š**

â€‹	â€¢	ç©å®¶å¯èƒ½åœ¨æ­»äº¡æ—¶æ­£åœ¨â€œçˆ¬å¢™â€æˆ–â€œè¸©åœ¨æŸä¸ªæ–œå¡ä¸Šâ€ï¼Œå¯¼è‡´å¤æ´»æ—¶ä½ç½®å¼‚å¸¸ã€‚

â€‹	â€¢	CharacterController ä¼šå°è¯•â€œçº æ­£â€è‡ªèº«ä½ç½®ï¼Œä½¿ç©å®¶å¡åœ¨æ­»äº¡ç‚¹é™„è¿‘ã€‚



âœ… **è§£å†³æ–¹æ³• (æ¨è)**ï¼š

â€‹	â€¢	åœ¨ Respawn() ä¸­çŸ­æš‚ç¦ç”¨ CharacterControllerï¼Œä»¥æ¸…é™¤ç¢°æ’ä¿¡æ¯ã€‚

â€‹	â€¢	åœ¨ Respawn() å†…åŠ ä¸Š yield return null;ï¼Œç¡®ä¿ Unity å¼•æ“å®Œæˆåœºæ™¯ä¸­ç‰©ç†ç¢°æ’çš„é‡è®¡ç®—ã€‚

```
public void Respawn()
{
    CharacterController controller = GetComponent<CharacterController>();
    
    if (controller != null)
    {
        controller.enabled = false;   // ç¦ç”¨æ¥æ¸…é™¤æ—§çš„ç¢°æ’æ•°æ®
    }

    transform.position = startingPosition;

    if (controller != null)
    {
        yield return null;            // ç­‰å¾…ä¸€å¸§ï¼Œç¡®ä¿ä½ç½®æ›´æ–°
        controller.enabled = true;    // å¯ç”¨åé‡æ–°è®¡ç®—ç¢°æ’
        controller.Move(Vector3.zero); // ç«‹å³åˆ·æ–°ç¢°æ’å™¨çŠ¶æ€
    }
}
```





------



**ğŸŸ¡ 3. ç©å®¶ä½ç½®å¯èƒ½è§¦å‘äº† â€œåœ°é¢æ£€æµ‹å¤±è´¥â€**



> CharacterController çš„ isGrounded å±æ€§ä¼šåœ¨æ¯ä¸€å¸§æ›´æ–°ã€‚å¦‚æœç©å®¶åœ¨ Respawn() æ—¶ä½ç½®è¿‡é«˜æˆ–æ‚¬ç©ºï¼ŒisGrounded å¯èƒ½è¿”å› falseï¼Œå¯¼è‡´ä½ç½®é”™è¯¯ã€‚



â— **é—®é¢˜æè¿°ï¼š**

â€‹	â€¢	ç©å®¶é‡ç”Ÿæ—¶å¯èƒ½ç•¥å¾®åç¦»åœ°é¢ï¼Œå¯¼è‡´ CharacterController è®¤ä¸ºç©å®¶ä»åœ¨â€œä¸‹è½â€çŠ¶æ€ã€‚

â€‹	â€¢	è¿™ç§æƒ…å†µä¸‹ï¼Œç©å®¶å¯èƒ½ç¬é—´æ‰è½åˆ°é”™è¯¯çš„ä½ç½®ã€‚



âœ… **è§£å†³æ–¹æ³• (æ¨è)**ï¼š

â€‹	â€¢	åœ¨ Respawn() ä¸­ç¡®ä¿ç©å®¶çš„ä½ç½®**ç¨å¾®ä½äºåœ°é¢**ï¼Œè§¦å‘ isGrounded = trueã€‚

â€‹	â€¢	å¯é€šè¿‡ Physics.Raycast æ£€æµ‹åœ°é¢é«˜åº¦ï¼Œå¹¶å°†ç©å®¶ä½ç½®è°ƒæ•´è‡³åˆé€‚çš„é«˜åº¦ã€‚

```
public void Respawn()
{
    Vector3 respawnPosition = startingPosition;

    // æ£€æµ‹åœ°é¢é«˜åº¦ï¼Œç¡®ä¿ç©å®¶æ­£ç¡®è´´åœ°
    if (Physics.Raycast(respawnPosition, Vector3.down, out RaycastHit hit, 3f))
    {
        respawnPosition.y = hit.point.y + 0.1f;  // ç¨å¾®æå‡ç©å®¶ä½ç½®ä»¥é˜²å¡åœ°é¢
    }

    transform.position = respawnPosition;

    CharacterController controller = GetComponent<CharacterController>();
    if (controller != null)
    {
        controller.enabled = false;   // ç¦ç”¨é‡ç½®çŠ¶æ€
        yield return null;            // ç­‰å¾…ä¸€å¸§
        controller.enabled = true;    // å¯ç”¨åç«‹å³åˆ·æ–°
        controller.Move(Vector3.zero); // å¼ºåˆ¶åˆ·æ–°
    }
}
```





------



**ğŸŸ¡ 4. æ‘„åƒæœº (Camera) çš„æ›´æ–°æ—¶åºé—®é¢˜**



> ç©å®¶ä½ç½®å¯èƒ½æ­£ç¡®æ›´æ–°ï¼Œä½† ResetCameras() æå‰è¿è¡Œï¼Œå¯¼è‡´æ‘„åƒæœºé”™è¯¯åœ°èšç„¦åœ¨åŸå§‹æ­»äº¡ç‚¹ã€‚



â— **é—®é¢˜æè¿°ï¼š**

â€‹	â€¢	ResetCameras() å¯èƒ½åœ¨ç©å®¶ä½ç½®æ›´æ–°å‰è¿è¡Œï¼Œå¯¼è‡´æ‘„åƒæœºé”™è¯¯è·Ÿè¸ªæ—§ä½ç½®ã€‚

â€‹	â€¢	è¿™ç§æƒ…å†µåœ¨ LateUpdate() ä¸ Update() ä¹‹é—´çš„æ—¶åºå†²çªæ—¶è¾ƒä¸ºå¸¸è§ã€‚



âœ… **è§£å†³æ–¹æ³• (æ¨è)**ï¼š

â€‹	â€¢	å°† ResetCameras() è°ƒæ•´è‡³ yield return null; ä¹‹åï¼Œç¡®ä¿ç©å®¶ä½ç½®å·²å®Œæˆæ›´æ–°ã€‚

```
m_level.player.Respawn();
yield return null;  // ç­‰å¾…ä¸€å¸§ç¡®ä¿ç©å®¶ä½ç½®æ›´æ–°
ResetCameras();     // æ‘„åƒæœºä½ç½®æ›´æ–°
```





------



**ğŸŸ¡ 5. FadeIn() å›è°ƒè¿‡æ—©è§¦å‘**



> m_fader.FadeIn() çš„å›è°ƒå¯èƒ½åœ¨ç©å®¶ä½ç½®åˆ·æ–°å®Œæˆå‰è§¦å‘ï¼Œå¯¼è‡´ç©å®¶ä½ç½®é”™è¯¯ã€‚



âœ… **è§£å†³æ–¹æ³• (æ¨è)**ï¼š

å°† FadeIn() çš„å›è°ƒå»¶è¿Ÿè‡³ç©å®¶ä½ç½®ã€æ‘„åƒæœºå®Œå…¨ç¨³å®šä¹‹åï¼š

```
yield return new WaitForSeconds(respawnFadeInDelay);
m_fader.FadeIn(() =>
{
    m_level.player.transform.position = startingPosition; // é¢å¤–ç¡®ä¿ä½ç½®æ­£ç¡®
    m_pauser.canPause = true;
    m_level.player.inputs.enabled = true;
});
```





------



**âœ… æœ€ä½³çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**



å°†æ‰€æœ‰ä¼˜åŒ–æ•´åˆï¼š

```
protected virtual IEnumerator RespawnRoutine(bool consumeRetries)
{
    if (consumeRetries)
    {
        m_game.retries--;
    }

    m_level.player.Respawn();
    yield return null;             // ç­‰å¾…ä¸€å¸§ä»¥ç¡®ä¿ Unity å¼•æ“å®Œæˆä½ç½®æ›´æ–°
    ResetCameras();                // æ‘„åƒæœºåœ¨ä½ç½®æ›´æ–°åå†é‡ç½®

    OnRespawn?.Invoke();

    yield return new WaitForSeconds(respawnFadeInDelay);
    m_fader.FadeIn(() =>
    {
        m_level.player.transform.position = startingPosition; // é¢å¤–ç¡®ä¿ä½ç½®æ­£ç¡®
        m_pauser.canPause = true;
        m_level.player.inputs.enabled = true;
    });
}
```





------



**ğŸš¨ æ€»ç»“**



âœ… **æœ€å¯èƒ½çš„åŸå› **ï¼š



> CharacterController åœ¨ transform.position æ›´æ–°åï¼Œå†…éƒ¨ç¢°æ’å™¨çŠ¶æ€æ²¡æœ‰ç«‹å³åŒæ­¥ï¼Œå¯¼è‡´ç©å®¶ä½ç½®é”™è¯¯ã€‚



âœ… **æœ€æœ‰æ•ˆçš„ä¿®æ­£**ï¼š



> åœ¨ Respawn() ä¸­æ·»åŠ  controller.enabled = false/true;ï¼Œå¹¶åœ¨é‡ç½®ç©å®¶ä½ç½®åæ·»åŠ  yield return null; ä»¥ç­‰å¾…ä¸€å¸§æ¥ç¡®ä¿ Unity å¼•æ“å®Œæˆæ›´æ–°ã€‚



è¿™ç§æ–¹æ³•æ›´ç¨³å®šï¼Œä¸”ä¸ä¾èµ– yield return new WaitForSeconds(1); è¿™ç§ä¸ç¡®å®šçš„æ—¶é—´ç¼“å†²ã€‚



å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–æˆ–è°ƒè¯•ï¼Œè¯·éšæ—¶æé—®ï¼ğŸ˜Š